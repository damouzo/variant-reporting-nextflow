---
title: "{{PROJECT_NAME}} - Structural Variants Quality Control Report"
subtitle: "{{GENE_NAME}} Gene Analysis"
author: "{{PROJECT_AUTHOR}} ({{PROJECT_CODE}})"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
    self-contained: true
    self-contained-math: true
    keep-md: false
    fig-width: 10
    fig-height: 6
lightbox:
  match: auto
  effect: zoom
  desc-position: bottom
  loop: true
execute:
  echo: false
  warning: false
  message: false

---

```{r setup}
#| include: false
library(tidyverse)
library(knitr)
library(kableExtra)
library(DT)
library(plotly)
library(gt)

# Set global options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center")

# Define data directory
data_dir <- "data"

# Project information from pipeline
project_info <- list(
  code = "{{PROJECT_CODE}}",
  name = "{{PROJECT_NAME}}",
  author = "{{PROJECT_AUTHOR}}",
  gene = "{{GENE_NAME}}"
)

# Function to render and display plots with specific order
display_plots_by_pattern <- function(data_dir, pattern_base, gene_name, var_type, plot_order) {
  # Define plot patterns in order: frequency, translocations, copy number, inversions
  plot_patterns <- c(
    "Frec_SVtype",
    "Circle_Translocation", 
    "CNV_Size_CN",
    "Inversions_Segments"
  )
  
  # Plot descriptions for captions
  plot_descriptions <- c(
    "structural variant frequency distribution by type",
    "translocation patterns in circular representation", 
    "copy number variant size and copy number analysis",
    "inversion segments analysis"
  )
  
  displayed_plots <- 0
  
  for (i in seq_along(plot_patterns)) {
    pattern <- plot_patterns[i]
    description <- plot_descriptions[i]
    
    # Construct expected filename
    plot_file <- paste0(gene_name, "_", pattern_base, "_", var_type, "_", pattern, ".pdf")
    pdf_path <- file.path(data_dir, plot_file)
    
    if (file.exists(pdf_path)) {
      displayed_plots <- displayed_plots + 1
      img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
      png_filename <- paste0(tolower(var_type), "_", pattern, "_", displayed_plots, ".png")
      png::writePNG(img, png_filename)
      
      # Display image WITHOUT lightbox - using HTML img tag
      cat('\n<div style="margin: 30px 0; text-align: center;">\n')
      cat('  <img src="', png_filename, '" style="width:100%; height:auto; border:1px solid #dee2e6; border-radius:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" alt="', str_to_title(var_type), ' ', description, '" />\n', sep = "")
      cat('</div>\n\n')
      cat('**_Figure:_** *', str_to_title(var_type), ' ', description, ' for {{GENE_NAME}}.*\n\n', sep = "")
    }
  }
  
  if (displayed_plots == 0) {
    cat("⚠️ No ", var_type, " plots found for pattern: ", pattern_base, "\n\n")
  }
  
  invisible(displayed_plots)
}

# Function to display participant metadata plots using simple Quarto lightbox like small_variants_report.qmd
display_metadata_plots <- function(data_dir, pattern_base, gene_name, var_type) {
  # Search for all PartMetadata files matching the pattern automatically
  search_pattern <- paste0(gene_name, "_", pattern_base, "_", var_type, "_PartMetadata_.*\\.pdf$")
  metadata_files <- list.files(data_dir, pattern = search_pattern, full.names = TRUE)
  
  displayed_plots <- 0
  
  if (length(metadata_files) > 0) {
    # Sort files to ensure "AllStructuralVar" comes first
    metadata_files <- sort(metadata_files)
    all_struct_idx <- grep("AllStructuralVar|AllstructuralVar", metadata_files, ignore.case = TRUE)
    
    if (length(all_struct_idx) > 0) {
      # Move "All structural variants" to the beginning
      all_struct_file <- metadata_files[all_struct_idx[1]]
      other_files <- metadata_files[-all_struct_idx[1]]
      metadata_files <- c(all_struct_file, other_files)
    }
    
    # Generate unique lightbox group for this section
    lightbox_group <- paste0(tolower(var_type), "-", gsub("[^a-zA-Z0-9]", "", pattern_base), "-metadata-gallery")
    
    # Convert all PDFs to PNG with simple names (no timestamps)
    png_files <- c()
    
    for (i in seq_along(metadata_files)) {
      pdf_path <- metadata_files[i]
      
      if (requireNamespace("pdftools", quietly = TRUE) && requireNamespace("png", quietly = TRUE)) {
        tryCatch({
          img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
          # Simple filename based on PDF name without timestamps
          pdf_basename <- tools::file_path_sans_ext(basename(pdf_path))
          png_filename <- paste0(pdf_basename, ".png")
          png::writePNG(img, png_filename)
          png_files <- c(png_files, png_filename)
          displayed_plots <- displayed_plots + 1
        }, error = function(e) {
          cat('<!-- Error converting PDF:', basename(pdf_path), ': ', e$message, ' -->\n')
        })
      }
    }
    
    if (length(png_files) > 0) {
      # Display ONLY the first image (main one), rest accessible via lightbox
      pdf_path <- metadata_files[1]
      pdf_name <- basename(pdf_path)
      
      # Show first image with lightbox group
      cat('![](', png_files[1], '){group="', lightbox_group, '" width="100%"}\n\n', sep = "")
      
      # Process remaining PDFs but DON'T display them (only for lightbox)
      if (length(png_files) > 1) {
        for (png_idx in 2:length(png_files)) {
          png_filename <- png_files[png_idx]
          
          # Add to lightbox group but hide from main view (without label)
          cat('![](', png_filename, '){group="', lightbox_group, '" style="display:none;"}\n\n', sep = "")
        }
      }
      
      # Add caption
      cat('**_Figure:_** *', str_to_title(var_type), ' participant metadata analysis for {{GENE_NAME}}', sep = "")
      if (length(png_files) > 1) {
        cat('. Click the image to view additional metadata plots (', length(png_files), ' plots available) in the gallery', sep = "")
      }
      cat('.*\n\n')
    }
  }
  
  if (displayed_plots == 0) {
    cat("⚠️ No ", var_type, " metadata plots found for pattern: ", pattern_base, "\n\n")
  }
  
  invisible(displayed_plots)
}
```

# Executive Summary

This report presents a detailed quality control analysis of structural variants (CNVs and SVs) identified in the **{{GENE_NAME}}** 
gene as part of the **{{PROJECT_CODE}}** research initiative. The analysis includes comprehensive QC visualizations for both 
germline and somatic variants, basic and custom filtering strategies, and detailed statistical summaries of variant distributions 
and participant metadata.

Key components of this report include:

- Quality control visualizations of CNV and SV distributions for germline and somatic variants
- Participant metadata analysis with demographic and clinical context  
- Comprehensive filtering analysis distinguishing somatic and germline variants
- Interactive tables for detailed variant exploration
- Statistical summaries of all analysis steps

---

# Raw Structural Variants QC

This section presents the quality control analysis of raw structural variants, organized by germline and somatic classifications 
to provide clear insights into the distinct patterns and characteristics of each variant type in the {{GENE_NAME}} gene.

## Germline Variants

### 1. Structural Variant Distribution and Classification
Below are quality-control plots providing a concise overview of germline structural variants identified in the {{GENE_NAME}} gene. 
The figures summarize variant type frequencies, translocation patterns, copy-number size and CN analyses, 
and inversion segment summaries to support interpretation and downstream filtering decisions.

```{r qc-germline-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Display germline plots in specific order: frequency, translocations, copy number, inversions
display_plots_by_pattern(data_dir, "QC", project_info$gene, "germline", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

### 2. Participant Metadata Analysis

```{r qc-germline-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_metadata_plots(data_dir, "QC", project_info$gene, "germline")
```

## Somatic Variants

### 1. Structural Variant Distribution and Classification

```{r qc-somatic-distribution}
#| echo: false  
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_plots_by_pattern(data_dir, "QC", project_info$gene, "somatic", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

### 2. Participant Metadata Analysis

```{r qc-somatic-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_metadata_plots(data_dir, "QC", project_info$gene, "somatic")
```

---

# Filtering Analysis

This section presents the results of filtering analysis applied to structural variants, organized by variant classification 
to provide comprehensive insights into germline and somatic variant patterns after quality control filtering.

## Basic Filtering

This subsection presents the results of basic filtering applied to the structural variants dataset. Basic filtering includes 
standard quality thresholds, frequency cutoffs, and classification criteria for CNVs and SVs.

### Basic Filtering Statistics

```{r basic-filter-stats-table}
#| echo: false

# Load basic filtering statistics
basic_stats_files <- list.files(data_dir, pattern = "*_structural_variants_filter_basic_stats\\.csv$", full.names = TRUE)

if (length(basic_stats_files) > 0) {
  basic_stats <- read_csv(basic_stats_files[1], show_col_types = FALSE)
  
  if (nrow(basic_stats) > 0) {
    # Create a nicely formatted table using gt
    basic_stats %>%
      mutate(
        metric = case_when(
          metric == "total_raw_variants" ~ "Total Raw Structural Variants",
          metric == "total_canonical_variants" ~ "Total Canonical Structural Variants", 
          metric == "total_canonical_cnv" ~ "   • CNV Variants",
          metric == "total_canonical_sv" ~ "   • SV Variants",
          metric == "total_canonical_germline" ~ "   • Germline Variants",
          metric == "total_canonical_somatic" ~ "   • Somatic Variants",
          TRUE ~ metric
        )
      ) %>%
      gt() %>%
      tab_header(
        title = paste("Basic Filtering Statistics for", project_info$gene),
        subtitle = "Progressive filtering steps with structural variant counts and number of participants"
      ) %>%
      cols_label(
        metric = "Filtering Step",
        variant_count = "Variant Count",
        participant_count = "Participant Count"
      ) %>%
      tab_style(
        style = list(
          cell_fill(color = "#f8f9fa"),
          cell_text(weight = "bold")
        ),
        locations = cells_column_labels()
      ) %>%
      fmt_number(
        columns = c(variant_count, participant_count),
        decimals = 0
      )
  } else {
    cat("No basic filtering statistics data available.")
  }
} else {
  cat("No basic filtering statistics files found.")
}
```

**_Table 1:_** *Progressive filtering statistics showing the impact of each filtering step on structural variant and participant counts.*

### Germline Basic Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r basic-filter-germline-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_plots_by_pattern(data_dir, "structural_variants_filter_basic", project_info$gene, "germline", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r basic-filter-germline-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_metadata_plots(data_dir, "structural_variants_filter_basic", project_info$gene, "germline")
```

### Somatic Basic Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r basic-filter-somatic-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_plots_by_pattern(data_dir, "structural_variants_filter_basic", project_info$gene, "somatic", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r basic-filter-somatic-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

display_metadata_plots(data_dir, "structural_variants_filter_basic", project_info$gene, "somatic")
```

### Filtered Variants Table

```{r basic-filtered-variants-table}
#| echo: false

# Load basic filtered variants for interactive table - using same simple approach that works
basic_filtered_files <- list.files(data_dir, pattern = "*_structural_variants_filter_basic_filtered\\.rds$", full.names = TRUE)

if (length(basic_filtered_files) > 0) {
  # Load and display table - simple approach like custom filters
  basic_filtered_data <- readRDS(basic_filtered_files[1])
  
  if (is.data.frame(basic_filtered_data) && nrow(basic_filtered_data) > 0) {
    # Use only available columns from the data
    all_cols <- names(basic_filtered_data)
    
    # Select first 10 most relevant columns to avoid table being too wide
    display_cols <- head(all_cols, 10)
    
    # Create simple datatable - same as custom filters
    datatable(
      basic_filtered_data[, display_cols, drop = FALSE],
      caption = paste("Basic Filtered Structural Variants for", project_info$gene),
      options = list(
        pageLength = 10,
        scrollX = TRUE,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel')
      ),
      rownames = FALSE
    )
  } else {
    cat("No basic filtered structural variant data available.")
  }
} else {
  cat("No basic filtered structural variants RDS files found.")
}
```

**_Table 2:_** *Interactive table of structural variants (combined germline and somatic) that passed basic filtering criteria for {{GENE_NAME}}. 
Use the search and filter features to explore specific variants of interest. Note: Tables typically contain both germline and somatic variants combined.*

---

## OnlyHaem Filtering

```{r check-onlyhaem-exists}
#| echo: false
onlyhaem_exists <- length(list.files(data_dir, pattern = "*_structural_variants_filter_onlyHaem_filtered\\.rds$")) > 0
```

```{r onlyhaem-section-header}
#| echo: false
#| results: asis
#| eval: !expr onlyhaem_exists

if (onlyhaem_exists) {
  cat("This subsection presents the results of OnlyHaem filtering applied to the structural variants dataset.\n\n")
}
```

### OnlyHaem Statistics

```{r onlyhaem-stats-table}
#| echo: false
#| eval: !expr onlyhaem_exists

onlyhaem_stats_files <- list.files(data_dir, pattern = "*_structural_variants_filter_onlyHaem_stats\\.csv$", full.names = TRUE)

if (length(onlyhaem_stats_files) > 0) {
  onlyhaem_stats <- read_csv(onlyhaem_stats_files[1], show_col_types = FALSE)
  
  if (nrow(onlyhaem_stats) > 0) {
    onlyhaem_stats %>%
      filter(grepl("filter_onlyHaem_after_custom_filtering", metric)) %>%
      mutate(
        metric = case_when(
          metric == "filter_onlyHaem_after_custom_filtering" ~ "Final OnlyHaem Structural Variants",
          TRUE ~ metric
        )
      ) %>%
      gt() %>%
      tab_header(
        title = "OnlyHaem Filtering Statistics",
        subtitle = paste("Custom filtering results for", project_info$gene)
      ) %>%
      cols_label(
        metric = "Filtering Step",
        variant_count = "Variant Count",
        participant_count = "Participant Count"
      ) %>%
      fmt_number(
        columns = c(variant_count, participant_count),
        decimals = 0
      )
  } else {
    cat("No OnlyHaem filtering statistics data available.")
  }
} else {
  cat("No OnlyHaem filtering statistics files found.")
}
```

**_Table:_** *OnlyHaem filtering statistics for structural variants.*

### Germline OnlyHaem Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r onlyhaem-germline-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr onlyhaem_exists

display_plots_by_pattern(data_dir, "structural_variants_filter_onlyHaem", project_info$gene, "germline", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r onlyhaem-germline-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr onlyhaem_exists

display_metadata_plots(data_dir, "structural_variants_filter_onlyHaem", project_info$gene, "germline")
```

### Somatic OnlyHaem Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r onlyhaem-somatic-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr onlyhaem_exists

display_plots_by_pattern(data_dir, "structural_variants_filter_onlyHaem", project_info$gene, "somatic", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r onlyhaem-somatic-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr onlyhaem_exists

display_metadata_plots(data_dir, "structural_variants_filter_onlyHaem", project_info$gene, "somatic")
```

### OnlyHaem Filtered Variants Table

```{r onlyhaem-filtered-variants-table}
#| echo: false
#| eval: !expr onlyhaem_exists

onlyhaem_filtered_files <- list.files(data_dir, pattern = "*_structural_variants_filter_onlyHaem_filtered\\.rds$", full.names = TRUE)

if (length(onlyhaem_filtered_files) > 0) {
  # Load and display table - same simple approach that works
  onlyhaem_data <- readRDS(onlyhaem_filtered_files[1])
  
  if (is.data.frame(onlyhaem_data) && nrow(onlyhaem_data) > 0) {
    # Use only available columns from the data
    all_cols <- names(onlyhaem_data)
    
    # Select first 10 most relevant columns to avoid table being too wide
    display_cols <- head(all_cols, 10)
    
    # Create simple datatable
    datatable(
      onlyhaem_data[, display_cols, drop = FALSE],
      caption = paste("OnlyHaem Filtered Structural Variants for", project_info$gene),
      options = list(
        pageLength = 10,
        scrollX = TRUE,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel')
      ),
      rownames = FALSE
    )
  } else {
    cat("No OnlyHaem filtered variants available.")
  }
}
```

**_Table 3:_** *Interactive table of structural variants (combined germline and somatic) that passed OnlyHaem filtering for {{GENE_NAME}}.*

---

## RmNeuro Filtering

```{r check-rmneuro-exists}
#| echo: false
rmneuro_exists <- length(list.files(data_dir, pattern = "*_structural_variants_filter_rmNeuro_filtered\\.rds$")) > 0
```

```{r rmneuro-section-header}
#| echo: false
#| results: asis
#| eval: !expr rmneuro_exists

if (rmneuro_exists) {
  cat("This subsection presents the results of rmNeuro filtering applied to the structural variants dataset.\n\n")
}
```

### RmNeuro Statistics

```{r rmneuro-stats-table}
#| echo: false
#| eval: !expr rmneuro_exists

rmneuro_stats_files <- list.files(data_dir, pattern = "*_structural_variants_filter_rmNeuro_stats\\.csv$", full.names = TRUE)

if (length(rmneuro_stats_files) > 0) {
  rmneuro_stats <- read_csv(rmneuro_stats_files[1], show_col_types = FALSE)
  
  if (nrow(rmneuro_stats) > 0) {
    rmneuro_stats %>%
      filter(grepl("filter_rmNeuro_after_custom_filtering", metric)) %>%
      mutate(
        metric = case_when(
          metric == "filter_rmNeuro_after_custom_filtering" ~ "Final RmNeuro Structural Variants",
          TRUE ~ metric
        )
      ) %>%
      gt() %>%
      tab_header(
        title = "RmNeuro Filtering Statistics",
        subtitle = paste("Custom filtering results for", project_info$gene)
      ) %>%
      cols_label(
        metric = "Filtering Step",
        variant_count = "Variant Count",
        participant_count = "Participant Count"
      ) %>%
      fmt_number(
        columns = c(variant_count, participant_count),
        decimals = 0
      )
  } else {
    cat("No rmNeuro filtering statistics data available.")
  }
} else {
  cat("No rmNeuro filtering statistics files found.")
}
```

**_Table:_** *RmNeuro filtering statistics for structural variants.*

### Germline RmNeuro Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r rmneuro-germline-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr rmneuro_exists

display_plots_by_pattern(data_dir, "structural_variants_filter_rmNeuro", project_info$gene, "germline", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r rmneuro-germline-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr rmneuro_exists

display_metadata_plots(data_dir, "structural_variants_filter_rmNeuro", project_info$gene, "germline")
```

### Somatic RmNeuro Filtered Variants

#### 1. Structural Variant Distribution and Classification

```{r rmneuro-somatic-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr rmneuro_exists

display_plots_by_pattern(data_dir, "structural_variants_filter_rmNeuro", project_info$gene, "somatic", c("Frec_SVtype", "Circle_Translocation", "CNV_Size_CN", "Inversions_Segments"))
```

#### 2. Participant Metadata Analysis

```{r rmneuro-somatic-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6
#| eval: !expr rmneuro_exists

display_metadata_plots(data_dir, "structural_variants_filter_rmNeuro", project_info$gene, "somatic")
```

### RmNeuro Filtered Variants Table

```{r rmneuro-filtered-variants-table}
#| echo: false
#| eval: !expr rmneuro_exists

rmneuro_filtered_files <- list.files(data_dir, pattern = "*_structural_variants_filter_rmNeuro_filtered\\.rds$", full.names = TRUE)

if (length(rmneuro_filtered_files) > 0) {
  # Load and display table - same simple approach that works
  rmneuro_data <- readRDS(rmneuro_filtered_files[1])
  
  if (is.data.frame(rmneuro_data) && nrow(rmneuro_data) > 0) {
    # Use only available columns from the data
    all_cols <- names(rmneuro_data)
    
    # Select first 10 most relevant columns to avoid table being too wide
    display_cols <- head(all_cols, 10)
    
    # Create simple datatable
    datatable(
      rmneuro_data[, display_cols, drop = FALSE],
      caption = paste("RmNeuro Filtered Structural Variants for", project_info$gene),
      options = list(
        pageLength = 10,
        scrollX = TRUE,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel')
      ),
      rownames = FALSE
    )
  } else {
    cat("No rmNeuro filtered variants available.")
  }
}
```

**_Table 4:_** *Interactive table of structural variants (combined germline and somatic) that passed rmNeuro filtering for {{GENE_NAME}}.*

---

# Report Information

**Pipeline Details:**  
- **Project Code**: {{PROJECT_CODE}}  
- **Project Name**: {{PROJECT_NAME}}  
- **Gene Analyzed**: {{GENE_NAME}}  
- **Report Type**: Structural Variants Quality Control  
- **Analysis Author**: {{PROJECT_AUTHOR}}  
- **Report Format**: HTML (Self-contained)  
- **Generation Date**: `r Sys.Date()`  
- **R Version**: `r R.version.string`  

---

*This report was generated automatically by the {{PROJECT_CODE}} Nextflow pipeline using Quarto.*  
*For questions about the analysis or interpretations, please contact the project team.*