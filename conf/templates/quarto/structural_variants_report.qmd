---
title: "{{PROJECT_NAME}} - Structural Variants Quality Control Report"
subtitle: "{{GENE_NAME}} Gene Analysis"
author: "{{PROJECT_AUTHOR}} ({{PROJECT_CODE}})"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
    self-contained: true
    self-contained-math: true
    keep-md: false
    fig-width: 10
    fig-height: 6
execute:
  echo: false
  warning: false
  message: false
lightbox:
  match: auto
  effect: zoom
  desc-position: bottom
  loop: true
---

```{r setup}
#| include: false
library(tidyverse)
library(knitr)
library(kableExtra)
library(DT)
library(plotly)
library(gt)

# Set global options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center")

# Define data directory
data_dir <- "data"

# Project information from pipeline
project_info <- list(
  code = "{{PROJECT_CODE}}",
  name = "{{PROJECT_NAME}}",
  author = "{{PROJECT_AUTHOR}}",
  gene = "{{GENE_NAME}}"
)
```

# Executive Summary

This report presents a detailed quality control analysis of structural variants (CNVs and SVs) identified in the **{{GENE_NAME}}** 
gene as part of the **{{PROJECT_CODE}}** research initiative. The analysis includes comprehensive QC visualizations for both 
germline and somatic variants, basic and custom filtering strategies, and detailed statistical summaries of variant distributions 
and participant metadata.

Key components of this report include:

- Quality control visualizations of CNV and SV distributions for germline and somatic variants
- Participant metadata analysis with demographic and clinical context
- Comprehensive filtering analysis distinguishing somatic and germline variants
- Interactive tables for detailed variant exploration
- Statistical summaries of all analysis steps

---

# Raw Structural Variants QC Analysis

## 1. Structural Variant Distribution and Classification

This section presents visualizations of all raw structural variant quality control metrics, including CNV and SV distributions, 
germline versus somatic classifications, and size distributions across the {{GENE_NAME}} gene.

```{r qc-struct-var-distribution}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Look for structural variant QC plots
struct_var_files <- list.files(data_dir, pattern = paste0(project_info$gene, "_QC.*\\.pdf$"), full.names = TRUE)

if (length(struct_var_files) > 0) {
  for (i in seq_along(struct_var_files)) {
    pdf_path <- struct_var_files[i]
    
    if (file.exists(pdf_path)) {
      img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
      png_filename <- paste0("qc_struct_var_", i, ".png")
      png::writePNG(img, png_filename)
      
      cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
    }
  }
} else {
  cat("⚠️ Structural variant QC plots not found.\n")
}
```

**_Figure 1-N:_** *Distribution of structural variants (CNVs and SVs) showing germline vs somatic classifications, size distributions, 
and frequency patterns across the {{GENE_NAME}} gene region.*

## 2. Participant Metadata Analysis

This section presents the demographic and clinical characteristics of participants with structural variants in {{GENE_NAME}}, 
providing crucial context for variant interpretation and population analysis.

```{r qc-participant-metadata}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Look for the specific QC participant metadata file
metadata_file <- paste0(project_info$gene, "_QC_StructVar_PartMetadata_Barplots.pdf")
pdf_path <- file.path(data_dir, metadata_file)

if (file.exists(pdf_path)) {
  # Convert PDF to PNG and display
  img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
  png_filename <- "qc_metadata_main.png"
  png::writePNG(img, png_filename)
  
  # Display the image
  cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
  
} else {
  cat("⚠️ Participant metadata plot not found:", metadata_file, "\n")
}
```

**_Figure 2:_** *Distribution of participants by demographic and clinical characteristics, including age, sex, 
disease categories, and other relevant metadata for individuals carrying {{GENE_NAME}} structural variants.*

---

# Filtering Analysis

## 3. Basic Filtering

This section presents the results of basic filtering applied to the structural variants dataset. Basic filtering includes 
standard quality thresholds, frequency cutoffs, and classification criteria for CNVs and SVs.

### 3.1 Basic Filtering Statistics

```{r basic-filter-stats-table}
#| echo: false

# Load basic filtering statistics
basic_stats_files <- list.files(data_dir, pattern = "*_struct_variants_filter_basic_stats\\.csv$", full.names = TRUE)

if (length(basic_stats_files) > 0) {
  basic_stats <- read_csv(basic_stats_files[1], show_col_types = FALSE)
  
  if (nrow(basic_stats) > 0) {
    # Create a nicely formatted table using gt
    basic_stats %>%
      mutate(
        metric = case_when(
          metric == "total_raw_variants" ~ "Total Raw Structural Variants",
          metric == "total_canonical_variants" ~ "Total Canonical Structural Variants", 
          metric == "total_canonical_cnv" ~ "   • CNV Variants",
          metric == "total_canonical_sv" ~ "   • SV Variants",
          metric == "total_canonical_germline" ~ "   • Germline Variants",
          metric == "total_canonical_somatic" ~ "   • Somatic Variants",
          TRUE ~ metric
        )
      ) %>%
      gt() %>%
      tab_header(
        title = paste("Basic Filtering Statistics for", project_info$gene),
        subtitle = "Progressive filtering steps with structural variant counts and number of participants"
      ) %>%
      cols_label(
        metric = "Filtering Step",
        variant_count = "Variant Count",
        participant_count = "Participant Count"
      ) %>%
      tab_style(
        style = list(
          cell_fill(color = "#f8f9fa"),
          cell_text(weight = "bold")
        ),
        locations = cells_column_labels()
      ) %>%
      fmt_number(
        columns = c(variant_count, participant_count),
        decimals = 0
      )
  } else {
    cat("No basic filtering statistics data available.")
  }
} else {
  cat("No basic filtering statistics files found.")
}
```

**_Table 1:_** *Progressive filtering statistics showing the impact of each filtering step on structural variant and participant counts.*

### 3.2 Variant Filter QC

```{r basic-filter-variant-plots}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 8

# Look for basic filtering plots
basic_filter_plot_files <- list.files(data_dir, pattern = ".*struct_variants_filter_basic.*\\.pdf$", full.names = TRUE)
basic_filter_plot_files <- basic_filter_plot_files[!grepl("PartMetadata", basic_filter_plot_files)]

if (length(basic_filter_plot_files) > 0) {
  for (plot_idx in seq_along(basic_filter_plot_files)) {
    pdf_path <- basic_filter_plot_files[plot_idx]
    
    if (file.exists(pdf_path)) {
      img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
      png_filename <- paste0("basic_filter_variant_plot_", plot_idx, ".png")
      png::writePNG(img, png_filename)
      
      cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
    }
  }
} else {
  cat("ℹ️ No basic filtering variant plot files found.\n")
}
```

**_Figure 3-N:_** *Structural variant distribution visualizations after basic filtering, showing CNV and SV patterns, 
germline versus somatic distributions, and size characteristics for high-quality variants in {{GENE_NAME}}.*

### 3.3 Participant Metadata

```{r basic-filter-participant-metadata}
#| echo: false
#| results: asis

# Look for basic filtering metadata plots
metadata_file <- paste0(project_info$gene, "_struct_variants_filter_basic_PartMetadata_Barplots.pdf")
pdf_path <- file.path(data_dir, metadata_file)

if (file.exists(pdf_path)) {
  img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
  png_filename <- "basic_metadata_main.png"
  png::writePNG(img, png_filename)
  
  cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
} else {
  cat("Participant metadata plots not found for basic filtering.\n")
}
```

**_Figure 4:_** *Distribution of participants carrying basic-filtered structural variants by demographic and clinical characteristics.*

### 3.4 Filtered Variants Table

```{r basic-filtered-variants-table}
#| echo: false

# Load basic filtered variants for interactive table
basic_filtered_files <- list.files(data_dir, pattern = "*_struct_variants_filter_basic_filtered\\.rds$", full.names = TRUE)

if (length(basic_filtered_files) > 0) {
  basic_filtered_data <- map_dfr(basic_filtered_files, ~{
    data <- readRDS(.x)
    if (is.data.frame(data) && nrow(data) > 0) {
      data
    } else {
      NULL 
    }
  })
  
  if (!is.null(basic_filtered_data) && nrow(basic_filtered_data) > 0) {
    # Select specific columns for display - adapt for structural variants
    display_cols <- c(
      "LabelVarPlot", "CHR_variant", "START_variant", "END_variant", 
      "SVTYPE_variant", "SVLEN_variant", "Classification_variant", 
      "MAX_AF_annotation", "NS_variant"
    )
    
    # Filter to available columns
    available_cols <- intersect(display_cols, names(basic_filtered_data))
    
    # Create interactive table with download buttons
    dt_table <- basic_filtered_data %>%
      select(any_of(available_cols)) %>%
      datatable(
        caption = paste("Basic Filtered Structural Variants for", project_info$gene),
        filter = 'top',
        extensions = c('Buttons'),
        options = list(
          pageLength = 10,
          scrollX = TRUE,
          autoWidth = TRUE,
          columnDefs = list(
            list(className = 'dt-center', targets = '_all')
          ),
          dom = 'Bfrtip',
          buttons = list(
            'copy',
            list(extend = 'csv', filename = paste0(project_info$gene, '_basic_filtered_struct_variants')),
            list(extend = 'excel', filename = paste0(project_info$gene, '_basic_filtered_struct_variants')),
            list(extend = 'pdf', filename = paste0(project_info$gene, '_basic_filtered_struct_variants'))
          )
        ),
        rownames = FALSE,
        class = 'cell-border stripe hover'
      )
    
    # Format SVTYPE column if it exists
    if ("SVTYPE_variant" %in% available_cols) {
      dt_table <- dt_table %>%
        formatStyle(
          'SVTYPE_variant',
          backgroundColor = styleEqual(
            c('DEL', 'DUP', 'INS', 'INV', 'BND', 'CNV'),
            c('#ffcccc', '#ccffcc', '#ffffcc', '#ccccff', '#ffccff', '#e6e6e6')
          )
        )
    }
    
    dt_table
  } else {
    cat("No basic filtered structural variant data available.")
  }
} else {
  cat("No basic filtered structural variants RDS files found.")
}
```

**_Table 2:_** *Interactive table of structural variants that passed basic filtering criteria for {{GENE_NAME}}. 
Use the search and filter features to explore specific variants of interest.*

---

## 4. Custom Filtering Results

```{r custom-filters-detection}
#| echo: false

# Detect custom filters by looking for non-basic filter files
all_filter_stats <- list.files(data_dir, pattern = ".*struct_variants_filter_.*_stats\\.csv$", full.names = TRUE)
custom_filter_stats <- all_filter_stats[!grepl("filter_basic", all_filter_stats)]

# Extract unique custom filter names
custom_filter_names <- c()
for (file in custom_filter_stats) {
  filter_match <- str_extract(basename(file), "filter_[^_]+")
  if (!is.na(filter_match) && filter_match != "filter_basic") {
    custom_filter_names <- c(custom_filter_names, filter_match)
  }
}
custom_filter_names <- unique(custom_filter_names)
```

```{r custom-filters-sections, results='asis'}
#| echo: false

if (length(custom_filter_names) > 0) {
  for (filter_name in custom_filter_names) {
    # Clean filter name for display
    filter_display <- str_replace_all(filter_name, "_", " ") %>% str_to_title()
    
    # Main filter section
    cat('\n### 4.', match(filter_name, custom_filter_names), ' ', filter_display, '\n\n', sep = "")
    
    # Statistics subsection
    cat('\n#### 4.', match(filter_name, custom_filter_names), '.1 ', filter_display, ' Statistics\n\n', sep = "")
    
    # Stats table for this custom filter
    custom_stats_file <- list.files(data_dir, pattern = paste0(".*", filter_name, "_stats\\.csv$"), full.names = TRUE)
    
    if (length(custom_stats_file) > 0) {
      custom_stats <- read_csv(custom_stats_file[1], show_col_types = FALSE)
      
      if (nrow(custom_stats) > 0) {
        stats_table <- custom_stats %>%
          filter(grepl(paste0(filter_name, "_after_custom_filtering"), metric)) %>%
          mutate(
            metric = paste("Final", filter_display, "Structural Variants")
          ) %>%
          gt() %>%
          tab_header(
            title = paste(filter_display, "Filtering Statistics"),
            subtitle = paste("Custom filtering results for", project_info$gene)
          ) %>%
          cols_label(
            metric = "Filtering Step",
            variant_count = "Variant Count", 
            participant_count = "Participant Count"
          ) %>%
          fmt_number(
            columns = c(variant_count, participant_count),
            decimals = 0
          )
        
        print(stats_table)
      }
    }
    
    cat('\n**_Table ', 2 + match(filter_name, custom_filter_names), ':_** ', filter_display, ' filtering statistics for structural variants.\n\n', sep = "")
    
    # Variant Filter QC subsection
    cat('\n#### 4.', match(filter_name, custom_filter_names), '.2 Variant Filter QC\n\n', sep = "")
    
    custom_plot_files <- list.files(data_dir, pattern = paste0(".*struct_variants_", filter_name, ".*\\.pdf$"), full.names = TRUE)
    variant_plot_files <- custom_plot_files[!grepl("PartMetadata", custom_plot_files)]
    
    if (length(variant_plot_files) > 0) {
      for (pdf_path in variant_plot_files) {
        if (file.exists(pdf_path)) {
          img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
          png_filename <- paste0("custom_", filter_name, "_variant_plot_", which(variant_plot_files == pdf_path), ".png")
          png::writePNG(img, png_filename)
          
          cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
        }
      }
      
      cat('\n**_Figure ', 4 + match(filter_name, custom_filter_names), ':_** *Structural variant distribution after ', filter_display, ' for {{GENE_NAME}}.*\n\n', sep = "")
    } else {
      cat('\nNo variant QC plots found for ', filter_display, '.\n\n', sep = "")
    }
    
    # Participant Metadata subsection
    cat('\n#### 4.', match(filter_name, custom_filter_names), '.3 Participant Metadata\n\n', sep = "")
    
    metadata_file <- paste0(project_info$gene, "_struct_variants_", filter_name, "_PartMetadata_Barplots.pdf")
    pdf_path <- file.path(data_dir, metadata_file)
    
    if (file.exists(pdf_path)) {
      img <- pdftools::pdf_render_page(pdf_path, page = 1, dpi = 300)
      png_filename <- paste0("custom_", filter_name, "_metadata_main.png")
      png::writePNG(img, png_filename)
      
      cat('![](', png_filename, '){width="100%"}\n\n', sep = "")
      
      cat('\n**_Figure ', 4 + length(custom_filter_names) + match(filter_name, custom_filter_names), ':_** *Participant distribution after ', filter_display, ' structural variant filtering.*\n\n', sep = "")
    } else {
      cat('\nNo participant metadata plots found for ', filter_display, '.\n\n', sep = "")
    }
    
    # Filtered Variants Table subsection
    cat('\n#### 4.', match(filter_name, custom_filter_names), '.4 Filtered Variants Table\n\n', sep = "")
    
    custom_filtered_files <- list.files(data_dir, pattern = paste0(".*", filter_name, "_filtered\\.rds$"), full.names = TRUE)
    
    if (length(custom_filtered_files) > 0) {
      custom_filtered_data <- readRDS(custom_filtered_files[1])
      
      if (is.data.frame(custom_filtered_data) && nrow(custom_filtered_data) > 0) {
        display_cols <- c(
          "LabelVarPlot", "CHR_variant", "START_variant", "END_variant", 
          "SVTYPE_variant", "SVLEN_variant", "Classification_variant", 
          "MAX_AF_annotation", "NS_variant"
        )
        
        available_cols <- intersect(display_cols, names(custom_filtered_data))
        
        dt_table <- custom_filtered_data %>%
          select(any_of(available_cols)) %>%
          datatable(
            caption = paste(filter_display, "Filtered Structural Variants for", project_info$gene),
            filter = "top",
            extensions = c('Buttons'),
            options = list(
              pageLength = 10, 
              scrollX = TRUE, 
              autoWidth = TRUE,
              columnDefs = list(
                list(className = 'dt-center', targets = '_all')
              ),
              dom = 'Bfrtip',
              buttons = list(
                'copy',
                list(extend = 'csv', filename = paste0(project_info$gene, '_', filter_name, '_filtered_struct_variants')),
                list(extend = 'excel', filename = paste0(project_info$gene, '_', filter_name, '_filtered_struct_variants')),
                list(extend = 'pdf', filename = paste0(project_info$gene, '_', filter_name, '_filtered_struct_variants'))
              )
            ),
            rownames = FALSE,
            class = "cell-border stripe hover"
          )
        
        if ("SVTYPE_variant" %in% available_cols) {
          dt_table <- dt_table %>%
            formatStyle("SVTYPE_variant", backgroundColor = styleEqual(c("DEL", "DUP", "INS", "INV", "BND", "CNV"), c("#ffcccc", "#ccffcc", "#ffffcc", "#ccccff", "#ffccff", "#e6e6e6")))
        }
        
        print(htmltools::tagList(dt_table))
        
        cat('\n\n**_Table ', 2 + length(custom_filter_names) + match(filter_name, custom_filter_names), ':_** *Interactive table of structural variants that passed ', filter_display, ' for {{GENE_NAME}}.*\n\n', sep = "")
      } else {
        cat("\nNo", filter_display, "filtered structural variants available.\n\n")
      }
    } else {
      cat("\nNo filtered structural variants table found for ", filter_display, ".\n\n", sep = "")
    }
    
    cat('\n---\n\n')
  }
} else {
  cat("No custom filtering has been applied to this structural variants dataset.\n\n")
}
```

---

# Report Information

**Pipeline Details:**  
- **Project Code**: {{PROJECT_CODE}}  
- **Project Name**: {{PROJECT_NAME}}  
- **Gene Analyzed**: {{GENE_NAME}}  
- **Report Type**: Structural Variants Quality Control  
- **Analysis Author**: {{PROJECT_AUTHOR}}  
- **Report Format**: HTML (Self-contained)  
- **Generation Date**: `r Sys.Date()`  
- **R Version**: `r R.version.string`  

---

*This report was generated automatically by the {{PROJECT_CODE}} Nextflow pipeline using Quarto.*  
*For questions about the analysis or interpretations, please contact the project team.*