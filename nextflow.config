// nextflow.config
nextflow.enable.dsl = 2


// Load config.yaml
import groovy.yaml.YamlSlurper

def loadConfig() {
    def configFileName = params.config_file ?: 'config_hpc_apocrita.yaml'
    def configFile = new File("${projectDir}/conf/${configFileName}")
    
    if (!configFile.exists()) {
       throw new Exception("Config file not found: ${configFile.absolutePath}")
    }
    
    return new YamlSlurper().parse(configFile)
}

params.config_file = 'config_hpc_apocrita.yaml'

def config = loadConfig()

// Helper function to build paths
def buildPath(basePath, relativePath) {
    return "${basePath}/${relativePath}".replaceAll('/+', '/')
}


// Params configuration based on YAML
params {

     // Project information
    project_code = config.project.code
    project_name = config.project.name
    project_author = config.project.author.name
    project_contact = config.project.author.contact
    start_date = config.project.start_date
    genome_assembly = config.project.genome
    
    // Paths Base
    data_root = config.base_paths.data_root
    output_root = config.base_paths.output_root
    
    // Paths Relatives
    raw_data_dir = buildPath(config.base_paths.data_root, config.paths.data.raw_data)
    processed_data_dir = buildPath(config.base_paths.data_root, config.paths.data.processed)
    smallvar_annot_dir = buildPath(config.base_paths.data_root, config.paths.data.smallvar_annot)
    structvar_annot_dir = buildPath(config.base_paths.data_root, config.paths.data.structvar_annot)
    prot_dir = buildPath(config.base_paths.data_root, config.paths.data.reference.protein)
    exon_dir = buildPath(config.base_paths.data_root, config.paths.data.reference.exon)

    // Directorio de resultados
    results_dir = buildPath(config.base_paths.output_root, config.paths.output.results)
    logs_dir = buildPath(config.base_paths.output_root, config.paths.output.logs)
    
    // Archivos específicos
    gene_list = buildPath(config.base_paths.data_root, config.files.gene_list)
    
    // Configuración externa
    enable_sql_queries = false
    labkey_main = config.external.labkey_project.main
    labkey_nhs = config.external.labkey_project.'nhs-gms'    

    // Environment info (con manejo seguro de valores null)
    environment_type = config.environment?.type ?: 'unknown'
    environment_executor = config.environment?.executor ?: 'local'
}

// Work directory 
workDir = config.paths.work

// Manifest con información del proyecto
manifest {
    name = config.project.code
    author = "${config.project.author.name} <${config.project.author.contact}>"
    description = config.project.name
    homePage = config.project.github ?: config.github ?: ''
    mainScript = 'main.nf'
}


// Process configuration
process {
    // Configuración por defecto desde YAML
    cpus = config.resources.default.cpus
    memory = config.resources.default.memory
    time = config.resources.default.time
    executor = config.environment?.executor ?: 'local'
    maxForks = 3  // Max 3 genes simultaneously
}

// Profile configuration
profiles {
    standard {
        process.executor = params.environment_executor
    }
    
    personal_pc {
        params.config_file = 'config_personal_pc.yaml'
        includeConfig 'conf/reports.config'
        
    }

    hpc_apocrita {
        params.config_file = 'config_hpc_apocrita.yaml'
        includeConfig 'conf/reports.config'

        singularity {
            enabled = true
            autoMounts = true
            cacheDir = '/data/scratch/qp241615/singularity-cache'
        }

        process {
            cpus = 1
            memory = "8 GB"
            time = "1h"
            penv = 'smp' 
                        
            withLabel: 'r_process' {
                cpus = 2  
                memory = "16 GB"
                time = "2h"
                container = '/data/BCI-KRP/projects/RR771-DHX34/conf/containers/container_r_clean.sif'
            }
            
            singularity {
            enabled = true
            autoMounts = true
            cacheDir = '/data/scratch/qp241615/singularity-cache'
            }
        }
    }
    
    ge_pc {
        params.config_file = 'config_ge_local.yaml'
        params.enable_sql_queries = true
         process {
            withLabel: 'r_process' {
                beforeScript = """
                module load R/4.3.3
                export R_LIBS_USER="/home/dmouzo/R/x86_64-pc-linux-gnu-library/4.3:/tools/aws-workspace-apps/ce/R/4.3.3"
                """
            }
        }
    }
    
    ge_hpc {
        params.config_file = 'config_hpc.yaml'
        process.executor = params.environment_executor
        process.queue = 'normal'
        includeConfig 'conf/reports.config'
    }
}


