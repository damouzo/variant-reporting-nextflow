// nextflow.config
nextflow.enable.dsl = 2


// Load config.yaml
import groovy.yaml.YamlSlurper

def loadConfig() {
    def configFile = new File("${projectDir}/conf/config_local.yaml")
    if (!configFile.exists()) {
        error "Config file not found: ${configFile.absolutePath}"
    }
    return new YamlSlurper().parse(configFile)
}

def config = loadConfig()

// Helper function to build paths
def buildPath(basePath, relativePath) {
    return "${basePath}/${relativePath}".replaceAll('/+', '/')
}


// Params configuration based on YAML
params {

     // Project information
    project_code = config.project.code
    project_name = config.project.name
    project_author = config.project.author.name
    project_contact = config.project.author.contact
    start_date = config.project.start_date
    genome_assembly = config.project.genome
    
    // Paths Base
    data_root = config.base_paths.data_root
    output_root = config.base_paths.output_root
    
    // Paths Relatives
    raw_data_dir = buildPath(config.base_paths.data_root, config.paths.data.raw_data)
    processed_data_dir = buildPath(config.base_paths.data_root, config.paths.data.processed)
    smallvar_annot_dir = buildPath(config.base_paths.data_root, config.paths.data.smallvar_annot)
    structvar_annot_dir = buildPath(config.base_paths.data_root, config.paths.data.structvar_annot)
    prot_dir = buildPath(config.base_paths.data_root, config.paths.data.reference.protein)
    exon_dir = buildPath(config.base_paths.data_root, config.paths.data.reference.exon)

    // Directorio de resultados
    results_dir = buildPath(config.base_paths.output_root, config.paths.output.results)
    logs_dir = buildPath(config.base_paths.output_root, config.paths.output.logs)
    
    // Archivos específicos
    gene_list = buildPath(config.base_paths.data_root, config.files.gene_list)
    
    // Configuración externa
    r_lib_path = config.external.libPath
    labkey_main = config.external.labkey_project.main
    labkey_nhs = config.external.labkey_project.'nhs-gms'    

    // Environment info (con manejo seguro de valores null)
    environment_type = config.environment?.type ?: 'unknown'
    environment_executor = config.environment?.executor ?: 'local'
}

// Work directory 
workDir = buildPath(config.base_paths.output_root, config.paths.output.work)

// Manifest con información del proyecto
manifest {
    name = config.project.code
    author = "${config.project.author.name} <${config.project.author.contact}>"
    description = config.project.name
    homePage = config.project.github ?: config.github ?: ''
    mainScript = 'main.nf'
}


// Process configuration
process {
    cpus = config.resources.default.cpus
    memory = config.resources.default.memory
    time = config.resources.default.time
    executor = config.environment?.executor ?: 'local'
    maxForks = 4  // Max 4 genes simultaneously

    // Configuraciones específicas por proceso
    // withName: 'HIGH_MEMORY_PROCESS' {
    //     cpus = config.resources.high_mem.cpus
    //     memory = config.resources.high_mem.memory
    //     time = config.resources.high_mem.time
    // }
    
    // Configuración para procesos de R (solo si libPath está definido)
    if (config.external.libPath) {
        withName: 'R_.*' {
            beforeScript = "export R_LIBS_USER=${config.external.libPath}"
        }
    }
}

// Configuración de perfiles
profiles {
    standard {
        process.executor = 'local'
    }
    
    cluster {
        process.executor = 'slurm'
        process.queue = 'normal'
    }
    
    docker {
        docker.enabled = false
        docker.userEmulation = false
    }
    
    singularity {
        singularity.enabled = false
        singularity.autoMounts = false
    }
}

// Logs and reports configuration
timeline {
    enabled = true
    file = "${params.results_dir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.results_dir}/pipeline_info/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.results_dir}/pipeline_info/execution_trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.results_dir}/pipeline_info/pipeline_dag.svg"
}

